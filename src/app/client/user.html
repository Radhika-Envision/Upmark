<div class="header"
    ng-class="{'deleted': user.deleted || user.organisation.deleted}">
<div class="container">
    <div class="toolbar">
        <delete-button model="user" editor="edit"
            ng-if="!edit.model && checkRole('user_del')"></delete-button>
        <button class="btn btn-default btn-round" title="Impersonate"
                ng-click="impersonate()"
                ng-if="checkRole('user_impersonate')">
            <i class="fa fa-paw"></i></button>
        <button class="btn btn-default btn-round" title="Cancel"
                ng-click="edit.cancel()"
                ng-if="edit.model && edit.model.id">
            <i class="fa fa-times"></i></button>
        <button class="btn btn-default btn-round" title="Save"
                ng-click="edit.save()"
                ng-if="edit.model"
                form="editor"
                form-save-button="editor">
            <i class="fa fa-check"></i></button>
        <button class="btn btn-default btn-round" title="Edit"
                ng-click="edit.edit()"
                ng-if="!edit.model && checkRole('user_edit')">
            <i class="fa fa-pencil"></i></button>
        <a class="btn btn-default btn-round" title="Subscriptions"
                ng-href="#/subscription/user?id={{user.id}}">
            <i class="fa fa-envelope"></i></a>
    </div>
    <h2 page-title>
        <i class="fa fa-fw fa-user"></i>
        <a href="#/org/{{user.organisation.id}}"
                ng-if="user.organisation"
                ng-class="{strike: user.organisation.deleted}">
            {{user.organisation.name}}</a>
        <a href="#/org/{{user.organisation.id}}"
                ng-if="!user.organisation">
            Users</a>
        &raquo;
        <span ng-if="user.name"
                ng-class="{strike: user.deleted}">
            {{user.name}}</span>
        <span ng-if="!user.name">New user</span>
    </h2>
</div>
</div>


<div ng-if="edit.model" class="container">
    <form novalidate name="form" id="editor" form-nav-warn>
        <div class="form-group" show-errors>
            <label for="user_name">Name</label>
            <span class="help-label" ng-if="form.user_name.$error.required">
                Please provide a name.</span>
            <input type="text" class="form-control" id="user_name" name="user_name"
                ng-model="edit.model.name" required />
        </div>
        <div class="form-group" show-errors>
            <label for="user_role">Role</label>
            <select type="text" class="form-control" id="user_role" name="user_role"
                ng-options="role.id as (role.name + ' - ' + role.description) for role in roles"
                ng-model="edit.model.role"></select>
        </div>
        <div class="form-group" show-errors>
            <label for="user_email">Email</label>
            <span class="help-label" ng-if="form.user_email.$error.required">
                Please provide an email address.</span>
            <span class="help-label" ng-if="form.user_email.$error.email">
                Please provide a valid email address.</span>
            <input type="email" class="form-control" id="user_email" name="user_email"
                ng-model="edit.model.email" required />
        </div>
        <div class="form-group" show-errors>
            <label for="user_email_interval">Timeline email frequency (days)</label>
            <span class="help-label" ng-if="form.user_email_interval.$error.required">
                *</span>
            <span class="help-label" ng-if="form.user_email_interval.$error.min">
                Negative numbers are not allowed</span>
            <span class="help-label" ng-if="form.user_email_interval.$error.number">
                Must be a number</span>
            <input type="number" class="form-control" seconds-as-days
                    id="user_email_interval" name="user_email_interval"
                    ng-model="edit.model.emailInterval"
                    required min="0" />
        </div>
        <docs>
            <i class="fa fa-li fa-border fa-envelope-o"></i>
            <h3>Email notifications</h3>
            <p>
                Notifications can be sent to your email address when activity
                in <a href="/#/">your timeline</a> changes. To opt out, set the
                email frequency to zero.
            </p>
        </docs>
        <div class="form-group">
            <label for="user_org">Organisation</label>
            <ui-select ng-model="edit.model.organisation"
                    ng-disabled="!checkRole('user_change_org')"
                    reset-search-input="false">
                <ui-select-match placeholder="Type to select organisation">{{edit.model.organisation.name}}</ui-select-match>
                <ui-select-choices
                        repeat="organisation in organisations | filter: $select.search"
                        refresh="searchOrg($select.search)"
                        refresh-delay="0">
                    <div ng-bind-html="organisation.name | highlight: $select.search"></div>
                </ui-select-choices>
            </ui-select>
        </div>

        <div class="form-group" show-errors>
            <label for="user_pwd">Password</label>
            <span class="help-label"
                    ng-if="edit.model.id && !edit.model.password">
                Optional</span>
            <span class="help-label"
                    ng-if="passwordCheck.strength < passwordCheck.threshold">
                Password is not strong enough
                ({{(passwordCheck.strength / passwordCheck.threshold) * 100 | number:0}}%)
            </span>
            <input type="password" class="form-control" id="user_pwd" name="user_pwd"
                ng-model="edit.model.password"
                ng-model-options="{debounce: {default: 1000, blur: 0}}" />
        </div>
        <div class="form-group" show-errors>
            <label for="user_pwd2">Re-enter password</label>
            <span class="help-label"
                    ng-if="edit.model.password && form.user_pwd2.$error.match">
                Passwords don't match.</span>
            <input type="password" class="form-control" id="user_pwd2" name="user_pwd2"
                ng-model="edit.model.password2" match="edit.model.password" />
        </div>
        <div class="form-group"
                ng-if="passwordCheck.strength < passwordCheck.threshold">
            <p>Password suggestions:</p>
            <ul>
                <li ng-repeat="item in passwordCheck.improvements">
                    {{item}}
                </li>
            </ul>
        </div>
    </form>
</div>

<div ng-if="!edit.model" class="container">
    <dl>
        <dt>Role</dt>
        <dd>{{roleDict[user.role].name}}
            <span class="text-muted">- {{roleDict[user.role].description}}</span>
        </dd>
    </dl>
    <dl ng-if="user.email">
        <dt>Email</dt>
        <dd><a ng-href="mailto:{{user.email}}" target="_blank">{{user.email}}</a></dd>
    </dl>
    <dl ng-if="checkRole('user_edit')">
        <dt>Timeline email frequency</dt>
        <dd ng-if="user.emailInterval > 0">
            <ng-pluralize count="user.emailInterval / (60 * 60 * 24)"
                 when="{'0': 'Notifications are disabled.',
                        '1': 'Notifications will be sent once per day.',
                        'other': 'Notifications will be sent every {} days.'}">
            </ng-pluralize>
        </dd>
        <dd ng-if="user.emailInterval <= 0">Email notifications are disabled.</dd>
    </dl>
    <dl>
        <dt>Organisation</dt>
        <dd><a ng-href="#/org/{{user.organisation.id}}">{{user.organisation.name}}</a></dd>
    </dl>

    <docs ng-if="user.deleted || user.organisation.deleted">
        <i class="fa-li fa fa-trash fa-border"></i>
        <h3>Deleted</h3>
        <p>
            This user, or their organisation, has been deleted. They can't log
            in any more, but the data they created still exists.
        </p>
    </docs>
</div>
