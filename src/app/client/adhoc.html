<div class="header">
<div class="container">
    <h2 page-title>
        Custom Query
    </h2>
</div>
</div>

<div class="container">
<form>
    <div class="form-group text-center">
        <button ng-click="format(query)"
                class="btn btn-default"
                title="Format">
            <i class="fa fa-paragraph"></i>
            <span class="sr-only">Format</span>
        </button>
        <span class="btn-group">
            <span class="btn-group-addon">
                <i class="fa fa-cloud-download"></i>
            </span>
            <button ng-click="download(query, 'csv')"
                    class="btn btn-default"
                    title="Execute and download as comma-separated values (text)">
                CSV
            </button>
            <button ng-click="download(query, 'xlsx')"
                    class="btn btn-default"
                    title="Execute and download as an Excel spreadsheet">
                Excel
            </button>
        </span>
        <button ng-click="execute(query)"
                class="btn btn-default"
                    title="Execute and display on this page">
            <i class="fa fa-play"></i>
            Execute
        </button>
        <span dropdown dropdown-append-to-body>
            <button class="btn btn-default" title="Presets" dropdown-toggle>
                <i class="fa fa-bookmark"></i></button>

            <ul class="dropdown-menu dropdown-menu-right">
                <li class="dropdown-header">Sample queries</li>
                <li ng-repeat="sample in samples">
                    <a href ng-click="setQuery(sample.query)">
                        {{sample.name}}
                    </a>
                </li>
            </ul>
        </span>
    </div>
    <div class="form-group"
            textarea-label="{{!query ? 'Enter SQL query' : ''}}">
        <textarea autoresize ng-model="query"
            class="autoresize form-control">
        </textarea>
    </div>

    <docs>
        <i class="fa-li fa fa-database fa-border"></i>
        <p>
            Enter a query to run against the database. Queries should be written
            as SQL in the
            <a href="http://www.postgresql.org/docs/9.4/static/sql-select.html">
                PostgreSQL dialect</a>.
            Only <code>SELECT</code> statements are allowed.
        </p>
        <p>
            Up to {{execLimit}} result rows can be displayed in browser window
            by pressing <i class="fa fa-play"></i> Execute. More rows can be
            returned by downloading the data as CSV or as an Excel spreadsheet.
        </p>
    </docs>

    <docs>
        <i class="fa-li fa fa-sitemap fa-border"></i>
        <h3>User tables</h3>
        <p>
            Users belong to organisations:
        </p>
        <img src="images/design-tables-user.svg" class="img-responsive">
        <dl>
            <dt>organisation</dt>
            <dd>
                <p>PK: <code>id</code>.</p>
                Stores details and metadata about organisations - both those
                taking part in surveys, and those authoring them.
            </dd>

            <dt>appuser</dt>
            <dd>
                <p>PK: <code>id</code>.</p>
                Stores credentials for users when logging in, and is used to
                identify actions (such as response edits).
                The <code>appuser.password</code> field is not accessible, so
                running <code>SELECT * FROM appuser</code> will fail. List the
                fields you want explicitly.
                <p>Email addresses are case-insensitive and unique.</p>
            </dd>
        </dl>
    </docs>
    <docs>
        <i class="fa-li fa fa-sitemap fa-border"></i>
        <h3>Survey tables</h3>
        <p>
            Survey questions are stored in the <code>survey</code>,
            <code>hierarchy</code>, <code>qnode</code> and
            <code>measure</code> tables. <code>qnode_measure_link</code> stores
            the many-to-many relationship between <code>qnode</code> and
            <code>measure</code>.
            The naming of these tables no longer matches the terminology in this
            web app: "programs" are stored in the <code>survey</code> table,
            "surveys" are stored in the <code>hierarchy</code> table, and
            "categories" are stored in the <code>qnode</code> table.
        </p>
        <img src="images/design-tables-survey.svg" class="img-responsive">
        <dl>
            <dt>survey</dt>
            <dd>
                <p>PK: <code>id</code>.</p>
                The survey table stores programs. Each program has a unique id,
                but may be linked to other program by using the same tracking
                id. This is used to maintain lineage when programs are
                duplicated. A program may have more than one survey (see
                hierarchy).
            </dd>

            <dt>hierarchy</dt>
            <dd>
                <p>PK: <code>id</code>, <code>survey_id</code>.</p>
                The hierarchy table stores surveys. Surveys have a collection of
                categories (qnodes).
                Each survey has an id which
                may be shared with other surveys of the same lineage in other
                programs.
            </dd>

            <dt>qnode</dt>
            <dd>
                <p>PK: <code>id</code>, <code>survey_id</code>.</p>
                Represents categories in the survey, used to group measures.
                Each qnode may have multiple measures or other qnodes as
                children.
            </dd>

            <dt>qnode_measure_link</dt>
            <dd>
                <p>
                    PK: <code>survey_id</code>, <code>qnode_id</code>,
                    <code>measure_id</code>.
                </p>
                Links qnodes to measures. This is required because a measure may
                belong to multiple categories (one per hierarchy) - or none, in
                which case it is orphaned.
            </dd>

            <dt>measure</dt>
            <dd>
                <p>PK: <code>id</code>, <code>survey_id</code>.</p>
                An actual question in a program. Measures can be shared between
                surveys, but not between programs. The
                <code>response_type</code> determines
                the options available to the user. That field is a soft link to
                data in <code>survey.response_types</code>.
            </dd>
        </dl>
    </docs>
    <docs>
        <i class="fa-li fa fa-sitemap fa-border"></i>
        <h3>Submission tables</h3>
        <p>
            Submissions are an organisation's answer to a survey. Generally,
            there is a one-to-many mapping between entities in the survey tables
            and those in the submission tables.
        </p>
        <img src="images/design-tables-response.svg" class="img-responsive">
        <dl>
            <dt>purchased_survey</dt>
            <dd>
                <p>PK: <code>survey_id</code>, <code>hierarchy_id</code>,
                    <code>organisation_id</code>.</p>
                Links an organisation to the surveys it has purchased.
            </dd>

            <dt>assessment</dt>
            <dd>
                <p>PK: <code>id</code>.</p>
                A submission against a survey.
            </dd>

            <dt>rnode</dt>
            <dd>
                <p>PK: <code>id</code>.</p>
                Caches aggregate scores within a category (i.e. the sum of the
                scores of the responses). Has no parent; to traverse the tree,
                traverse the qnodes instead.
            </dd>

            <dt>response</dt>
            <dd>
                <p>PK: <code>id</code>.</p>
                An actual response to a question (measure). The
                <code>response_parts</code> field is the authoritative response;
                the <code>score</code> is the cached, calculated score.
            </dd>

            <dt>attachment</dt>
            <dd>
                <p>PK: <code>id</code>.</p>
                Files and links; supporting documentation for a response.
                Usually files will not be stored in the actual database;
                instead, the <code>url</code> field will point to the actual
                location (not accessible through this screen).
            </dd>
        </dl>
    </docs>
</form>

<div ng-if="result.cols">
    <div class="scroll-x">
    <table class="table">
        <thead>
            <tr>
                <th ng-repeat="col in result.cols track by $index">
                    {{col.name}}
                </th>
            </tr>
        </thead>
        <tbody>
            <tr ng-repeat="row in result.rows track by $index">
                <td ng-repeat="cell in row track by $index"
                        ng-class="colClass($index)"
                        ng-switch="colRichType($index)">
                    <span ng-switch-when="float">{{cell | number:2}}</span>
                    <span ng-switch-when="int">{{cell | number:0}}</span>
                    <span ng-switch-when="datetime">{{cell | date}}</span>
                    <span ng-switch-when="json">{{cell}}</span>
                    <span ng-switch-default>{{cell}}</span>
                </td>
            </tr>
        </tbody>
    </table>
    </div> <!-- scroll-x -->

    <div class="spaced">
        <p ng-if="result.cols && !result.rows">Empty result set.</p>
        <p class="text-warning text-center"
                ng-if="result.rows.length >= execLimit">
            <small>
                <i class="fa fa-bug"></i>
                Results in web view are limited to {{execLimit}} items. If you
                want the next page, add an
                <a title="PostgreSQL docs on LIMIT and OFFSET"
                    href="http://www.postgresql.org/docs/9.4/static/queries-limit.html"
                    ><code>OFFSET</code></a>
                to your query or <i class="fa fa-cloud-download"></i> download
                the results.
            </small>
        </p>
    </div>
</div>
</div>
